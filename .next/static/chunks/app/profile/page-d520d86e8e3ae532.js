(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[636],{4568:(e,r,t)=>{"use strict";t.d(r,{AuthProvider:()=>m,A:()=>y});var a=t(5155),l=t(2115),s=t(6203),o=t(6104);let n=()=>{let[e,r]=(0,l.useState)(null),[t,a]=(0,l.useState)(!0),[n,i]=(0,l.useState)(null);return(0,l.useEffect)(()=>{let e=(0,s.hg)(o.j,async e=>{if(e)try{await e.reload(),r(e)}catch(e){console.error("重新載入用戶資料失敗:",e),i(e)}else r(null);a(!1)},e=>{console.error("認證狀態監聽錯誤:",e),i(e),a(!1)});return()=>e()},[]),{user:e,loading:t,error:n}};var i=t(6671);let c=()=>{let e=async e=>{try{await (0,s.oM)(o.j,e?s.F0:s.iM)}catch(e){throw console.error("設定持久化失敗:",e),e}};return{registerWithEmail:async r=>{let{email:t,password:a,name:l}=r;try{await e(!0);let r=await (0,s.eJ)(o.j,t,a);return await (0,s.r7)(r.user,{displayName:l}),i.o.success("註冊成功！",{description:"歡迎加入 EchoMind",duration:3e3}),r.user}catch(e){throw d(e),e}},loginWithEmail:async r=>{let{email:t,password:a,rememberMe:l=!1}=r;try{await e(l);let r=await (0,s.x9)(o.j,t,a);return i.o.success("登入成功！",{description:"歡迎回來",duration:3e3}),r.user}catch(e){throw d(e),e}},loginWithGoogle:async function(){let r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];try{await e(r);let t=new s.HF;t.setCustomParameters({prompt:"select_account"});let a=await (0,s.df)(o.j,t);return i.o.success("Google 登入成功！",{description:"歡迎回來",duration:3e3}),a.user}catch(e){throw d(e),e}},logout:async()=>{try{await (0,s.CI)(o.j),i.o.success("登出成功！",{description:"期待您的再次使用",duration:3e3})}catch(e){throw d(e),e}}}},d=e=>{let r=u(e.code);console.error("認證錯誤:",e),i.o.error("操作失敗",{description:r,duration:3e3})},u=e=>({"auth/email-already-in-use":"此電子郵件已被註冊","auth/invalid-email":"無效的電子郵件格式","auth/operation-not-allowed":"此登入方式未啟用","auth/weak-password":"密碼強度不足","auth/user-disabled":"此帳號已被停用","auth/user-not-found":"找不到此用戶","auth/wrong-password":"密碼錯誤","auth/popup-closed-by-user":"登入視窗被關閉","auth/popup-blocked":"登入視窗被阻擋","auth/cancelled-popup-request":"登入請求已取消","auth/network-request-failed":"網路連線失敗","auth/too-many-requests":"登入嘗試次數過多，請稍後再試","auth/requires-recent-login":"請重新登入以繼續操作","auth/account-exists-with-different-credential":"此電子郵件已使用其他登入方式註冊"})[e]||"發生未知錯誤，請稍後再試",h=(0,l.createContext)(null),y=()=>{let e=(0,l.useContext)(h);if(!e)throw Error("useAuth 必須在 AuthProvider 內使用");return e},m=e=>{let{children:r}=e,{user:t,loading:l,error:s}=n(),{registerWithEmail:o,loginWithEmail:i,loginWithGoogle:d,logout:u}=c();return l?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-gray-900 dark:border-white"})}):(0,a.jsx)(h.Provider,{value:{user:t,loading:l,error:s,registerWithEmail:o,loginWithEmail:i,loginWithGoogle:d,logout:u},children:r})}},5266:(e,r,t)=>{Promise.resolve().then(t.bind(t,7497))},6104:(e,r,t)=>{"use strict";t.d(r,{j:()=>n});var a=t(3915),l=t(6203),s=t(5317);let o=(0,a.Dk)().length?(0,a.Dk)()[0]:(0,a.Wp)({apiKey:"AIzaSyCaDYOtTLe1iEMISjyohHSiTTkJ94mkGeg",authDomain:"echomind2-afcdb.firebaseapp.com",projectId:"echomind2-afcdb",storageBucket:"echomind2-afcdb.firebasestorage.app",messagingSenderId:"378106540923",appId:"1:378106540923:web:f9fe5d7cf1cf8827a343de"}),n=(0,l.xI)(o);(0,s.aU)(o)},7161:(e,r,t)=>{"use strict";t.d(r,{Ph:()=>s,Wq:()=>n,XL:()=>c,_h:()=>i,eg:()=>o});var a=t(6203),l=t(6104);let s=e=>(0,a.hg)(l.j,r=>{e(r)}),o=async(e,r)=>{try{if(!l.j.currentUser)throw Error("沒有登入的用戶");await (0,a.r7)(l.j.currentUser,{displayName:e,photoURL:r})}catch(e){throw console.error("更新用戶資料失敗:",e),e}},n=async(e,r)=>{try{return await (0,a.eJ)(l.j,e,r)}catch(e){throw console.error("電子郵件註冊失敗:",e),e}},i=async(e,r)=>{try{return await (0,a.x9)(l.j,e,r)}catch(e){throw console.error("電子郵件登入失敗:",e),e}},c=async()=>{try{let e=new a.HF;return await (0,a.df)(l.j,e)}catch(e){throw console.error("Google 登入失敗:",e),e}}},7497:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>j});var a=t(5155),l=t(2115),s=t(4568),o=t(5695),n=t(1007),i=t(4355),c=t(1264),d=t(9074),u=t(9434),h=t(7161),y=t(6855),m=t(5709),g=t(6671),p=t(9509),b=t(9641).Buffer;let f=((()=>{let e=Object.entries({NEXT_PUBLIC_R2_API_ENDPOINT:p.env.NEXT_PUBLIC_R2_API_ENDPOINT,NEXT_PUBLIC_R2_ACCESS_KEY_ID:p.env.NEXT_PUBLIC_R2_ACCESS_KEY_ID,NEXT_PUBLIC_R2_SECRET_ACCESS_KEY:p.env.NEXT_PUBLIC_R2_SECRET_ACCESS_KEY,NEXT_PUBLIC_R2_BUCKET:p.env.NEXT_PUBLIC_R2_BUCKET,NEXT_PUBLIC_R2_ENDPOINT:p.env.NEXT_PUBLIC_R2_ENDPOINT}).filter(e=>{let[,r]=e;return!r}).map(e=>{let[r]=e;return r});if(e.length>0)throw console.error("缺少必要的環境變數:",e),Error("缺少必要的環境變數: ".concat(e.join(", ")))})(),new y.Y({region:"auto",endpoint:p.env.NEXT_PUBLIC_R2_API_ENDPOINT,credentials:{accessKeyId:p.env.NEXT_PUBLIC_R2_ACCESS_KEY_ID,secretAccessKey:p.env.NEXT_PUBLIC_R2_SECRET_ACCESS_KEY},forcePathStyle:!0})),x=p.env.NEXT_PUBLIC_R2_BUCKET,w=async e=>new Promise((r,t)=>{let a=new FileReader;a.onload=()=>{a.result instanceof ArrayBuffer?r(b.from(a.result)):t(Error("Failed to convert file to buffer"))},a.onerror=()=>t(a.error),a.readAsArrayBuffer(e)}),v=async(e,r)=>{try{console.log("正在上傳文件到 R2...",{bucket:x,path:r,fileType:e.type,fileSize:e.size});let t=await w(e);await f.send(new m.w({Bucket:x,Key:r,Body:t,ContentType:e.type}));let a="https://".concat(p.env.NEXT_PUBLIC_R2_ENDPOINT,"/").concat(r);return console.log("文件上傳成功，URL:",a),a}catch(e){throw console.error("文件上傳失敗:",e),g.o.error("文件上傳失敗，請稍後再試"),e}},N=async(e,r)=>{if(!e.type.startsWith("image/"))throw g.o.error("請上傳圖片文件"),Error("Invalid file type");if(e.size>5242880)throw g.o.error("圖片大小不能超過 5MB"),Error("File too large");let t=e.name.split(".").pop();return v(e,"avatars/".concat(r,"/").concat(Date.now(),".").concat(t))};var _=t(6766);function j(){let{user:e,loading:r}=(0,s.A)(),t=(0,o.useRouter)(),[y,m]=(0,l.useState)(!1),[g,p]=(0,l.useState)(!1),b=(0,l.useRef)(null),[f,x]=(0,l.useState)({displayName:"",email:"",photoURL:""});(0,l.useEffect)(()=>{r||e?e&&x({displayName:e.displayName||"",email:e.email||"",photoURL:e.photoURL||""}):t.push("/login")},[e,r,t]);let w=()=>{y&&b.current&&b.current.click()},v=async r=>{var t;let a=null===(t=r.target.files)||void 0===t?void 0:t[0];if(a&&e)try{p(!0);let r=await N(a,e.uid);await (0,h.eg)(void 0,r),x(e=>({...e,photoURL:r}))}catch(e){console.error("頭像上傳失敗:",e)}finally{p(!1)}},j=async r=>{if(r.preventDefault(),e)try{await (0,h.eg)(f.displayName,f.photoURL),m(!1)}catch(e){console.error("更新失敗:",e)}};return r?(0,a.jsx)("div",{className:"flex min-h-[calc(100vh-5rem)] items-center justify-center",children:(0,a.jsx)("div",{className:"h-32 w-32 animate-pulse rounded-full bg-gray-200 dark:bg-gray-700"})}):(0,a.jsx)("div",{className:"container mx-auto max-w-4xl px-4 py-8",children:(0,a.jsxs)("div",{className:"rounded-lg bg-white p-6 shadow-lg dark:bg-gray-800",children:[(0,a.jsxs)("div",{className:"mb-8 text-center",children:[(0,a.jsxs)("div",{className:"relative mx-auto mb-4 h-32 w-32",children:[(0,a.jsx)("div",{className:(0,u.cn)("relative h-full w-full overflow-hidden rounded-full border-4 border-gray-200 dark:border-gray-700",y&&"cursor-pointer hover:opacity-80"),onClick:w,children:g?(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-gray-100 dark:bg-gray-700",children:(0,a.jsx)("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent"})}):f.photoURL?(0,a.jsx)(_.default,{src:f.photoURL,alt:f.displayName||"用戶頭像",className:"h-full w-full object-cover",width:128,height:128}):(0,a.jsx)("div",{className:"flex h-full w-full items-center justify-center bg-gray-100 text-gray-400 dark:bg-gray-700",children:(0,a.jsx)(n.A,{className:"h-16 w-16"})})}),y&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{className:"absolute bottom-0 right-0 rounded-full bg-blue-500 p-2 text-white hover:bg-blue-600",onClick:w,children:(0,a.jsx)(i.A,{className:"h-5 w-5"})}),(0,a.jsx)("input",{ref:b,type:"file",accept:"image/*",onChange:v,className:"hidden"})]})]}),(0,a.jsx)("h1",{className:"mb-2 text-2xl font-bold text-gray-900 dark:text-white",children:f.displayName||"未設置名稱"}),(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400",children:f.email})]}),(0,a.jsxs)("form",{onSubmit:j,className:"space-y-6",children:[(0,a.jsxs)("div",{className:"grid gap-6 md:grid-cols-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"用戶名稱"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(n.A,{className:"pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"}),(0,a.jsx)("input",{type:"text",name:"displayName",value:f.displayName,onChange:e=>{let{name:r,value:t}=e.target;x(e=>({...e,[r]:t}))},disabled:!y,className:(0,u.cn)("w-full rounded-lg border bg-white py-2 pl-10 pr-3 text-gray-700 shadow-sm","focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500","dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400",!y&&"cursor-not-allowed opacity-75"),placeholder:"請輸入用戶名稱"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"電子郵件"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(c.A,{className:"pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"}),(0,a.jsx)("input",{type:"email",value:f.email,disabled:!0,className:"w-full cursor-not-allowed rounded-lg border border-gray-300 bg-gray-100 py-2 pl-10 pr-3 text-gray-700 opacity-75 dark:border-gray-600 dark:bg-gray-600 dark:text-gray-300"})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300",children:"加入時間"}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(d.A,{className:"pointer-events-none absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400"}),(0,a.jsx)("input",{type:"text",value:(null==e?void 0:e.metadata.creationTime)?new Date(e.metadata.creationTime).toLocaleString():"未知",disabled:!0,className:"w-full cursor-not-allowed rounded-lg border border-gray-300 bg-gray-100 py-2 pl-10 pr-3 text-gray-700 opacity-75 dark:border-gray-600 dark:bg-gray-600 dark:text-gray-300"})]})]}),(0,a.jsx)("div",{className:"flex justify-end space-x-4",children:y?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("button",{type:"button",onClick:()=>{m(!1),x({displayName:(null==e?void 0:e.displayName)||"",email:(null==e?void 0:e.email)||"",photoURL:(null==e?void 0:e.photoURL)||""})},className:"rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600",children:"取消"}),(0,a.jsx)("button",{type:"submit",className:"rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700",children:"保存"})]}):(0,a.jsx)("button",{type:"button",onClick:()=>m(!0),className:"rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700",children:"編輯資料"})})]})]})})}},9434:(e,r,t)=>{"use strict";t.d(r,{cn:()=>s});var a=t(2596),l=t(9688);function s(){for(var e=arguments.length,r=Array(e),t=0;t<e;t++)r[t]=arguments[t];return(0,l.QP)((0,a.$)(r))}}},e=>{var r=r=>e(e.s=r);e.O(0,[992,888,79,40,998,103,441,684,358],()=>r(5266)),_N_E=e.O()}]);